<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora UCN - Historial</title>
  <style>
    /* Reset + simple styles */
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--glass:rgba(255,255,255,0.04);--text:#e6eef6;--danger:#ef4444}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071029 0%, #071a2a 100%);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:100%;max-width:420px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 24px rgba(2,6,23,0.6);}
    /* Splash */
    .splash{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:28px;text-align:center}
    .logo{width:92px;height:92px;border-radius:20px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;color:#021826}
    .loader{width:80px;height:6px;background:var(--glass);border-radius:20px;overflow:hidden}
    .loader > i{display:block;height:100%;background:linear-gradient(90deg,transparent,var(--accent));width:30%;animation:slide 1.4s infinite}
    @keyframes slide{0%{transform:translateX(-120%)}50%{transform:translateX(20%)}100%{transform:translateX(120%)}}
    /* Forms */
    h1{margin:0;font-size:20px}
    label{display:block;font-size:13px;margin-top:12px;color:#bcd3df}
    input{width:100%;padding:10px 12px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .btn{display:inline-block;padding:10px 14px;margin-top:14px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:#021826;font-weight:600}
    .btn.danger{background:var(--danger);color:#021826}
    .muted{font-size:13px;color:#9fb6c8;margin-top:8px}
    /* Calculator */
    .display{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;text-align:right;font-size:28px;min-height:56px;overflow:hidden}
    .keyboard{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    .key{padding:14px;border-radius:10px;background:rgba(255,255,255,0.02);text-align:center;font-size:18px;cursor:pointer;user-select:none;transition:background 0.1s}
    .key:hover{background:rgba(255,255,255,0.05);}
    .key.op{background:rgba(6,182,212,0.12)}
    .key.op:hover{background:rgba(6,182,212,0.2)}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .link{background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;font-size:13px;cursor:pointer}
    .link.solid{border:none;background:rgba(255,255,255,0.1);font-weight:600;}

    /* Historial styles */
    .history-list{max-height:300px;overflow-y:auto;margin-top:16px;padding-right:8px;}
    .history-item{background:rgba(255,255,255,0.02);padding:10px 12px;border-radius:8px;margin-bottom:8px;font-size:14px;border-left:3px solid var(--accent);box-shadow:0 1px 3px rgba(0,0,0,0.2)}
    .history-item .expression{color:#bcd3df;font-size:12px;}
    .history-item .result{font-weight:600;color:var(--text);font-size:16px;}
    .history-item .timestamp{font-size:10px;color:#678093;margin-top:4px;text-align:right;}
    .history-empty{text-align:center;padding:20px;border:1px dashed var(--glass);border-radius:8px;color:#9fb6c8}

    /* small helpers */
    .hidden{display:none}
    footer{margin-top:12px;font-size:12px;color:#93b0c0;text-align:center}
    .error{color:#ffb4b4;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="app card">
    <!-- Splash -->
    <section id="splash" class="splash">
      <div class="logo">UCN</div>
      <div>
        <h1>Bienvenido a tu App - UCN x Sebastian Montoya</h1>
        <div class="muted">Preparando la aplicación...</div>
      </div>
      <div class="loader"><i></i></div>
    </section>

    <!-- Login / Inicio -->
    <section id="login" class="hidden">
      <div class="topbar">
        <h1>Iniciar sesión</h1>
        <div class="link" id="toAbout">¿Proyecto?</div>
      </div>
      <label for="user">Usuario (puede ser tu nombre)</label>
      <input id="user" placeholder="Ej. Valeria Montoya" />
      <label for="pass">Clave (puede ser cualquier texto)</label>
      <input id="pass" type="password" placeholder="Escribe una clave" />
      <div id="loginError" class="error hidden">Debes completar usuario y clave.</div>
      <button id="btnLogin" class="btn">Entrar</button>
      <div class="muted">Si no quieres una cuenta real, usa cualquier nombre y clave — esto es un prototipo local realizado por Sebastian Montoya.</div>
    </section>

    <!-- Main / Calculadora -->
    <section id="main" class="hidden">
      <div class="topbar">
        <h1 id="title">Calculadora</h1>
        <div style="display:flex; gap:8px;">
          <button id="btnHistory" class="link solid">Historial</button>
          <button id="btnLogout" class="link">Cerrar</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div id="display" class="display">0</div>
        <div class="keyboard" id="keys">
          <!-- Row 1 -->
          <div class="key" data-key="7">7</div>
          <div class="key" data-key="8">8</div>
          <div class="key" data-key="9">9</div>
          <div class="key op" data-key="/">÷</div>
          <!-- Row 2 -->
          <div class="key" data-key="4">4</div>
          <div class="key" data-key="5">5</div>
          <div class="key" data-key="6">6</div>
          <div class="key op" data-key="*">×</div>
          <!-- Row 3 -->
          <div class="key" data-key="1">1</div>
          <div class="key" data-key="2">2</div>
          <div class="key" data-key="3">3</div>
          <div class="key op" data-key="-">−</div>
          <!-- Row 4 -->
          <div class="key" data-key="0">0</div>
          <div class="key" data-key=".">.</div>
          <div class="key" id="clear">C</div>
          <div class="key op" data-key="+">+</div>
          <!-- Row 5 -->
          <div class="key" style="grid-column:1/span 4;" id="equals">=</div>
        </div>
      </div>

      <footer>Proyecto para UCN - Interfaz: Splash, Login + (ADM de consultas)</footer>
    </section>

    <!-- Historial de Operaciones -->
    <section id="historyView" class="hidden">
      <div class="topbar">
        <h1>Historial de Operaciones</h1>
        <button id="backFromHistory" class="link">Volver</button>
      </div>

      <div class="muted" style="margin-top:10px;">Profesor acá puedes ver las últimas operaciones guardadas localmente.</div>

      <div class="history-list" id="historyList">
        <!-- El historial se renderizará aquí -->
      </div>

      <div id="historyEmpty" class="history-empty hidden">
        No hay operaciones guardadas aún.
      </div>
      
      <div style="margin-top:20px; text-align:center;">
        <div id="historyConfirmation" class="error hidden" style="color:var(--accent); font-weight:600; margin-bottom:10px;"></div>
        <button id="btnClearHistory" class="btn danger hidden">
          Limpiar Historial
        </button>
      </div>

    </section>

    <!-- About modal (simple) -->
    <section id="about" class="hidden">
      <h1>Sobre este proyecto</h1>
      <div class="muted">Este prototipo es una single-page app (un solo archivo). Contiene:
        <ul>
          <li>Splash (animación corta)</li>
          <li>Pantalla de inicio/logeo (usuario + clave)</li>
          <li>Interfaz principal: calculadora básica y **gestión de historial UCN**</li>
        </ul>
      </div>
      <div style="margin-top:10px"><button id="backFromAbout" class="btn">Volver</button></div>
    </section>
  </div>

  <script>
    // Manejo de vistas
    const $splash = document.getElementById('splash');
    const $login = document.getElementById('login');
    const $main = document.getElementById('main');
    const $about = document.getElementById('about');
    const $historyView = document.getElementById('historyView'); // Nueva vista

    // Actualizamos la función show para incluir la nueva vista
    function show(node){ [$splash,$login,$main,$about,$historyView].forEach(n=>n.classList.add('hidden')); node.classList.remove('hidden'); }

    // Mostrar splash -> luego login
    setTimeout(()=>{ show($login); }, 1600);

    // navegación about
    document.getElementById('toAbout').addEventListener('click', ()=> show($about));
    document.getElementById('backFromAbout').addEventListener('click', ()=> show($login));

    // Login simple (no persistente)
    document.getElementById('btnLogin').addEventListener('click', ()=>{
      const user = document.getElementById('user').value.trim();
      const pass = document.getElementById('pass').value.trim();
      const err = document.getElementById('loginError');
      if(!user || !pass){ err.classList.remove('hidden'); return; }
      err.classList.add('hidden');
      document.getElementById('title').textContent = `Calculadora — ${user}`;
      show($main);
    });

    document.getElementById('btnLogout').addEventListener('click', ()=>{ document.getElementById('user').value=''; document.getElementById('pass').value=''; show($login); });

    // --- Lógica de Historial (localStorage) ---
    const HISTORY_KEY = 'calcHistoryUCN';

    /**
     * Carga el historial desde localStorage.
     * @returns {Array} Lista de operaciones históricas.
     */
    function loadHistory() {
      try {
        const historyJson = localStorage.getItem(HISTORY_KEY);
        return historyJson ? JSON.parse(historyJson) : [];
      } catch (e) {
        console.error('Error al cargar historial:', e);
        return [];
      }
    }

    /**
     * Guarda el historial actualizado en localStorage.
     * @param {Array} historyArray El array de historial a guardar.
     */
    function saveHistory(historyArray) {
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(historyArray));
      } catch (e) {
        console.error('Error al guardar historial:', e);
      }
    }

    /**
     * Guarda una nueva entrada de historial.
     * @param {string} rawExpression Expresión con operadores JS (* /).
     * @param {string} result Resultado de la operación.
     */
    function saveHistoryEntry(rawExpression, result) {
      if (result === 'Error') return; // No guardar si hay error

      const history = loadHistory();
      const now = new Date();

      // Formato para mostrar: reemplaza * por × y / por ÷
      const displayExpression = rawExpression.replace(/\*/g,'×').replace(/\//g,'÷');

      history.unshift({ // Agregar la entrada al inicio (más reciente primero)
        id: Date.now(),
        date: now.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'medium' }),
        expression: displayExpression,
        result: result,
      });

      // Limitar historial a 50 entradas (opcional)
      while(history.length > 50) history.pop();
      
      saveHistory(history);
    }

    /**
     * Renderiza la lista de historial en la vista.
     */
    function renderHistory() {
      const history = loadHistory();
      const $list = document.getElementById('historyList');
      const $empty = document.getElementById('historyEmpty');
      const $btnClear = document.getElementById('btnClearHistory');
      
      $list.innerHTML = ''; // Limpiar lista anterior

      if (history.length === 0) {
        $empty.classList.remove('hidden');
        $btnClear.classList.add('hidden');
        return;
      }

      $empty.classList.add('hidden');
      $btnClear.classList.remove('hidden');

      history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.dataset.id = item.id;
        div.innerHTML = `
          <div class="expression">${item.expression} = <span class="result">${item.result}</span></div>
          <div class="timestamp">${item.date}</div>
        `;
        $list.appendChild(div);
      });
    }
    
    /**
     * Limpia todo el historial de operaciones y actualiza la vista.
     */
    function handleClearHistory() {
      const confirmationMsg = document.getElementById('historyConfirmation');
      
      // Simulación de confirmación visual simple
      confirmationMsg.textContent = 'Historial limpiado correctamente.';
      confirmationMsg.classList.remove('hidden');
      confirmationMsg.style.color = 'var(--accent)';

      saveHistory([]);
      renderHistory();

      setTimeout(() => {
        confirmationMsg.classList.add('hidden');
      }, 2000);
    }

    // --- Listeners de Historial ---
    document.getElementById('btnHistory').addEventListener('click', () => {
      renderHistory();
      show($historyView);
    });

    document.getElementById('backFromHistory').addEventListener('click', () => {
      show($main);
    });

    document.getElementById('btnClearHistory').addEventListener('click', handleClearHistory);

    // --- Lógica de la CALCULADORA (Modificada) ---
    const display = document.getElementById('display');
    let expr = '';

    function updateDisplay(){ display.textContent = expr || '0'; }

    document.getElementById('keys').addEventListener('click', (e)=>{
      const k = e.target.closest('.key'); if(!k) return;
      if(k.id === 'clear'){ expr = ''; updateDisplay(); return; }

      // Lógica de IGUAL (donde se guarda el historial)
      if(k.id === 'equals'){ 
        try{ 
          // Reemplazar símbolos visuales por operadores JS
          const safe = expr.replace(/×/g,'*').replace(/÷/g,'/');
          
          // bloquear caracteres inesperados
          if(/[^0-9+\-*/(). ]/.test(safe)){ throw 'caracteres inválidos' }
          
          // Evaluar expresión
          const res = Function('return ('+safe+')')(); 
          
          // Guardar el historial ANTES de actualizar la expresión
          saveHistoryEntry(safe, String(res));

          expr = String(res);
          updateDisplay();
        }catch(e){ 
          display.textContent = 'Error'; 
          setTimeout(()=>{ expr=''; updateDisplay(); },900); 
        }
        return;
      }

      const key = k.dataset.key;
      if(!key) return;
      
      // normalizar multiplicación/división visual
      const normalized = key.replace('*','×').replace('/','÷');
      
      // Lógica de construcción de expresión
      if(['+','-','*','/','.','0','1','2','3','4','5','6','7','8','9'].includes(key)){
        // keep expression with JS operators for eval
        expr += key;
        updateDisplay();
      }
    });

    // teclado físico (opcional)
    window.addEventListener('keydown', (e)=>{
      if($main.classList.contains('hidden')) return;
      if((e.key>='0' && e.key<='9') || ['+','-','*','/','.','(',')'].includes(e.key)){
        expr += e.key; updateDisplay();
      }
      if(e.key === 'Enter'){
        document.getElementById('equals').click();
      }
      if(e.key === 'Backspace'){
        expr = expr.slice(0,-1); updateDisplay();
      }
    });
    
  </script>
</body>
</html>
